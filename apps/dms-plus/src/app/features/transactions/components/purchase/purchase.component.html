<div class="container-fluid">
  <div class="row">
    <div class="col-md-12">
      <div class="card">
        <div class="card-header">
          <h5>New Purchase</h5>
        </div>
        <div class="card-body">
          <form [formGroup]="purchaseForm" (ngSubmit)="onSubmit()">
            <!-- Supplier Details -->
            <div class="row mb-3">
              <div class="col-md-6">
                <label class="form-label">Supplier Name *</label>
                <input type="text" class="form-control" formControlName="supplierName" required>
              </div>
              <div class="col-md-3">
                <label class="form-label">Invoice Number *</label>
                <input type="text" class="form-control" formControlName="invoiceNumber" required>
              </div>
              <div class="col-md-3">
                <label class="form-label">Invoice Date *</label>
                <input type="date" class="form-control" formControlName="invoiceDate" required>
              </div>
            </div>

            <!-- Items Section -->
            <div class="card mt-4">
              <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="mb-0">Purchase Items</h6>
                <button type="button" class="btn btn-sm btn-primary" (click)="addItem()">
                  <i class="feather icon-plus"></i> Add Item
                </button>
              </div>
              <div class="card-body">
                <div formArrayName="items">
                  <div *ngFor="let item of itemsArray.controls; let i = index" 
                       [formGroupName]="i" class="row align-items-end mb-3 border-bottom pb-3">
                    
                    <div class="col-md-3">
                      <label class="form-label">Product *</label>
                      <select class="form-control" formControlName="productId" required>
                        <option value="">Select Product</option>
                        <option *ngFor="let product of products" [value]="product.productid">
                          {{ product.product_name }}
                        </option>
                      </select>
                    </div>
                    
                    <div class="col-md-2">
                      <label class="form-label">Quantity *</label>
                      <input type="number" class="form-control" formControlName="quantity" 
                             min="1" (input)="onQuantityOrRateChange(i)" required>
                    </div>
                    
                    <div class="col-md-2">
                      <label class="form-label">Purchase Rate *</label>
                      <input type="number" class="form-control" formControlName="purchaseRate" 
                             min="0" step="0.01" (input)="onQuantityOrRateChange(i)" required>
                    </div>
                    
                    <div class="col-md-2">
                      <label class="form-label">Sale Rate *</label>
                      <input type="number" class="form-control" formControlName="saleRate" 
                             min="0" step="0.01" required>
                    </div>
                    
                    <div class="col-md-2">
                      <label class="form-label">Total</label>
                      <input type="number" class="form-control" formControlName="total" readonly>
                    </div>
                    
                    <div class="col-md-1">
                      <button type="button" class="btn btn-sm btn-danger" 
                              (click)="removeItem(i)" 
                              [disabled]="itemsArray.length <= 1">
                        <i class="feather icon-trash-2"></i>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Summary Section -->
            <div class="card mt-4">
              <div class="card-body">
                <div class="row">
                  <div class="col-md-6">
                    <div class="form-group">
                      <label class="form-label">Discount (%)</label>
                      <input type="number" class="form-control" formControlName="discount" 
                             min="0" max="100" step="0.01">
                    </div>
                  </div>
                  <div class="col-md-6">
                    <table class="table table-sm">
                      <tr>
                        <td><strong>Sub Total:</strong></td>
                        <td class="text-end">{{ calculateSubTotal() | currency:'PKR':'symbol':'1.2-2' }}</td>
                      </tr>
                      <tr>
                        <td><strong>Discount:</strong></td>
                        <td class="text-end">{{ calculateDiscountAmount() | currency:'PKR':'symbol':'1.2-2' }}</td>
                      </tr>
                      <tr class="table-info">
                        <td><strong>Total:</strong></td>
                        <td class="text-end"><strong>{{ calculateTotal() | currency:'PKR':'symbol':'1.2-2' }}</strong></td>
                      </tr>
                    </table>
                  </div>
                </div>
              </div>
            </div>

            <!-- Action Buttons -->
            <div class="row mt-4">
              <div class="col-md-12 text-end">
                <button type="button" class="btn btn-secondary me-2" (click)="cancel()">
                  Cancel
                </button>
                <button type="submit" class="btn btn-success" 
                        [disabled]="purchaseForm.invalid || isLoading || calculateTotal() <= 0">
                  <span *ngIf="isLoading" class="spinner-border spinner-border-sm me-2" role="status"></span>
                  {{ isLoading ? 'Processing...' : 'Record Purchase' }}
                </button>
              </div>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>